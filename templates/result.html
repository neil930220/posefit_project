{% extends "base.html" %}
{% block content %}
  <h1>é æ¸¬çµæœ</h1>
  <img src="{{ file_url }}" style="max-width:400px;">
  <ul>
    <li>é¡åˆ¥ï¼š{{ prediction }}</li>
    <li>ä¿¡å¿ƒåˆ†æ•¸ï¼š{{ confidence }}</li>
    <li>é£Ÿç‰©é¢ç©æ¯”ï¼š{{ ratio }}</li>
  </ul>
  <h2>ç†±é‡ & ç‡Ÿé¤Šç´  æ¨æ¸¬</h2>
  <p>{{ gemini }}</p>
  <a href="{% url 'upload' %}">å†è©¦ä¸€æ¬¡</a>

  {# hidden form just to get the CSRF token #}
  <form id="history-form" style="display:none;">
    {% csrf_token %}
  </form>

  <script>
    (async function(){
      // ğŸš© guard: only run on a fresh navigation, not back/forward or reload
      const navEntries = performance.getEntriesByType("navigation");
      if (navEntries.length && navEntries[0].type !== "navigate") {
        console.log("Skipping history save on nonâ€initial navigation:", navEntries[0].type);
        return;
      }
    
      // grab CSRF token
      const csrfToken = document
        .querySelector('#history-form input[name="csrfmiddlewaretoken"]')
        .value;
    
      // your view must supply these:
      const detections = {{ detections_json|safe }};
      const totalCalories = {{ total_calories }};
    
      // re-fetch the image
      const imgResp  = await fetch("{{ file_url }}");
      const imgBlob  = await imgResp.blob();
    
      // build form data
      const fd = new FormData();
      fd.append("image", imgBlob, "scan.jpg");
      fd.append("detections", JSON.stringify(detections));
      fd.append("total_calories", totalCalories);
    
      // POST to DRF endpoint
      await fetch("/api/history/entries/", {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken },
        credentials: "same-origin",
        body: fd,
      });
    
      console.log("History saved.");
    })();
    </script>    
{% endblock %}
