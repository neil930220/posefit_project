{% extends "base.html" %}
{% block content %}
<div id="app">
  <!-- UPLOAD FORM -->
  <form @submit.prevent="onSubmit">
    {% csrf_token %}
    <input type="file" @change="onFileChange" accept="image/*" required>

    {% verbatim %}
    <button type="submit" :disabled="loading">
      <span v-if="loading">åˆ†æä¸­â€¦</span>
      <span v-else>ä¸Šå‚³ä¸¦åˆ†æ</span>
    </button>
    {% endverbatim %}
  </form>

  <!-- STATES -->
  <div v-if="!result && !loading">
    <p>è«‹é¸æ“‡ä¸€å¼µåœ–ç‰‡ä¸¦ä¸Šå‚³é–‹å§‹åˆ†æã€‚</p>
  </div>
  {% verbatim %}
  <div v-else-if="loading">
    <p>åˆ†æä¸­ï¼Œè«‹ç¨å€™â€¦</p>
  </div>
  <div v-else>
    <h2>é æ¸¬çµæœ</h2>
    <img :src="result.file_url" style="max-width:400px;">

    <ul>
      <li>é¡åˆ¥ï¼š<span v-text="result.prediction"></span></li>
      <li>ä¿¡å¿ƒåˆ†æ•¸ï¼š<span v-text="result.confidence"></span></li>
      <li>é£Ÿç‰©é¢ç©æ¯”ï¼š<span v-text="result.ratio"></span></li>
    </ul>

    <h3>ç†±é‡ & ç‡Ÿé¤Šç´  æ¨æ¸¬</h3>
    <p v-text="result.gemini"></p>

    <p>ç¸½ç†±é‡ï¼š<span v-text="result.total_calories"></span> å¤§å¡</p>

    <button @click="reset()">å†è©¦ä¸€æ¬¡</button>
  </div>
  {% endverbatim %}
</div>

<!-- Vue 3 -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      file: null,
      loading: false,
      result: null,
    };
  },
  methods: {
    onFileChange(e) {
      this.file = e.target.files[0];
    },
    async onSubmit() {
      if (!this.file) return;
      this.loading = true;
      this.result  = null;

      try {
        const fd = new FormData();
        fd.append('image', this.file);

        const response = await fetch("{% url 'analyzing_page' %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('input[name=csrfmiddlewaretoken]').value
          },
          body: fd,
          credentials: 'same-origin'
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        // ğŸ“Œ only call json() ONCE
        const data = await response.json();
        console.log("ğŸ’¡ API result:", data);

        this.result  = data;
        this.loading = false;

        // save to history
        this.saveHistory();
      } catch(err) {
        console.error(err);
        this.loading = false;
        alert('åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    },
    async saveHistory() {
      if (!this.result) return;
      const fd = new FormData();
      fd.append('image', this.file, this.file.name);
      fd.append('detections', JSON.stringify(this.result.detections));
      fd.append('total_calories', this.result.total_calories);

      await fetch('/api/history/entries/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('input[name=csrfmiddlewaretoken]').value
        },
        body: fd,
        credentials: 'same-origin'
      });
    },
    reset() {
      this.file = null;
      this.result = null;
      this.$el.querySelector('input[type=file]').value = '';
    }
  }
}).mount('#app');

</script>
{% endblock %}
